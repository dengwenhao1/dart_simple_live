name: app-build-action

# è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨ç‚¹å‡» "Run workflow" æŒ‰é’®è§¦å‘
  workflow_dispatch:
  
  # 2. æ¨é€ Tag æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - "dev_tv_v*"

jobs:
  build-tv:
    # ç¼–è¯‘ç¯å¢ƒ
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      # 1. ç­¾å‡ºä»£ç 
      - uses: actions/checkout@v4
        # ä¸æŒ‡å®š refï¼Œé»˜è®¤ç­¾å‡ºå½“å‰åˆ†æ”¯æˆ– Tag

      # 2. è®¾ç½® JAVA ç¯å¢ƒ (Java 17 é€‚é… Flutter 3.x)
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      # 3. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Flutter action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x"
          cache: true

      # 4. ä¸‹è½½ä¾èµ–åŒ…
      - name: Restore packages
        run: |
          cd simple_live_tv_app
          flutter pub get

      # 5. æ‰“åŒ… APK (å…³é”®æ­¥éª¤)
      # æ­¤æ—¶ä½¿ç”¨çš„æ˜¯ build.gradle.kts é‡Œé…ç½®çš„ debug ç­¾åï¼Œæ— éœ€å¯†é’¥
      # å»æ‰äº† --split-per-abiï¼Œç”ŸæˆåŒ…å«æ‰€æœ‰æ¶æ„çš„é€šç”¨åŒ…ï¼Œå…¼å®¹æ€§æœ€å¼º
      - name: Build APK
        run: |
          cd simple_live_tv_app
          flutter build apk --release --target-platform android-arm,android-arm64

      # 6. ä¸Šä¼  APK è‡³ Artifacts
      # æ³¨æ„ï¼šä¸æ‹†åˆ†åŒ…çš„æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æ–‡ä»¶åé»˜è®¤æ˜¯ app-release.apk
      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android_tv_universal
          path: simple_live_tv_app/build/app/outputs/flutter-apk/app-release.apk

      # 7. å®Œæˆæç¤º
      - run: echo "ğŸ Build finished. Please download 'android_tv_universal' and install app-release.apk"
